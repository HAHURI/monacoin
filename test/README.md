このディレクトリには、monacoindとそのユーティリティ全体をテストする統合テストが含まれています。
ただし、[/src/test](/src/test), [/src/wallet/test](/src/wallet/test)などにある単体テストは含まれていません。

現在、このディレクトリには2セットのテストがあります。

- [機能](/test/functional)RPCおよびP2Pインターフェイスを介して対話することにより、monacoindおよびmonacoin-qtの機能をテストします。
- [util](/test/util) モナコインユーティリティをテストします。現在はモナコイン-txのみです。


utilテストは、`make check`ターゲットの一部として実行されます。
機能テストは、プルリクエストが開かれるたびにtravis連続ビルドプロセスによって実行されます。 両方のテストセットをローカルで実行することもできます。

# テストをローカルで実行する

最初にシステム用にビルドします。 構成するときは、必ずウォレット、ユーティリティ、デーモンを有効にしてください。 それ以外の場合、テストは実行されません。

### 機能テスト

#### 依存関係

ZMQ機能テストには、Python ZMQライブラリが必要です。
次をインストールしておいてください:

- Unixの場合： `sudo apt-get install python3-zmq`を実行します
- macOSの場合：, `pip3 install pyzmq`を実行します

#### テストを実行する

個々のテストは、テストスクリプトを直接呼び出すことで実行できます。
例：

```
test/functional/feature_rbf.py
```

または、test_runnerハーネスを介して実行できます。
例：

```
test/functional/test_runner.py feature_rbf.py
```

次を呼び出して、テストの任意の組み合わせ（重複を含む）を実行できます。

```
test/functional/test_runner.py <testname1> <testname2> <testname3> ...
```

以下を使用して回帰テストスイートを実行します。

```
test/functional/test_runner.py
```

可能なすべてのテストを実行します

```
test/functional/test_runner.py --extended
```

デフォルトでは、test_runnerにより最大4つのテストが並行して実行されます。 

以下指定してください。
実行するジョブの数：`--jobs=n`を追加します

個々のテストとtest_runnerハーネスには、多くのコマンドラインオプションがあります。それらをすべて表示するには、`test_runner.py -h`を実行します。

#### テストエラーのトラブルシューティングとデバッグ

##### リソースの競合

テスト対象のモナコインドノードで使用されるP2PポートとRPCポートは、他のプロセスとの競合を起こさないように選択されます。
ただし、システム上で別のmonacoindプロセスが実行されている場合（おそらく、以前のテストですべてのmonacoindノードを正常に終了していない場合）、ポートの競合が発生する可能性があります
テストが失敗します。このような場合は、他のmonacoindプロセスが実行されていないシステムでテストを実行することをお勧めします。

Linuxでは、テストの開始時に別のmonacoindプロセスが実行されている場合、test_frameworkが警告します。

テストの失敗後にゾンビモナコインドプロセスがある場合、次のコマンドを実行してそれらを強制終了できます。
**これらのコマンドは、システムで実行中のすべてのmonacoindプロセスを強制終了するため、テスト以外のmonacoindプロセスが実行されている場合は使用しないでください。**

```bash
killall monacoind
```

もしくは

```bash
pkill -9 monacoind
```


##### データディレクトリキャッシュ

機能テストが最初に実行されたときに、200ブロックの事前にマイニングされたブロックチェーンが生成され、テスト/キャッシュに保存されます。これにより、テストごとに新しいブロックチェーンを生成する必要がないため、テストの起動時間が短縮されます。
ただし、キャッシュが悪い状態になる可能性があり、その場合、テストは失敗します。 これが発生した場合は、キャッシュディレクトリを削除します（上記のようにmonacoindプロセスが停止していることを確認します）。

```bash
rm -rf cache
killall monacoind
```

##### テストログ

テストには、さまざまなレベル（デバッグ、情報、警告など）でのロギングが含まれます。

以下デフォルト：
- test_runnerハーネスを介して実行すると、*すべて*ログが `test_framework.log`に書き込まれ、ログはコンソールに出力されません。
- 直接実行すると、*すべての*ログが `test_framework.log`に書き込まれ、INFOレベル以上がコンソールに出力されます。
- Travisで実行すると、ログはコンソールに出力されません。 ただし、テストが失敗すると、`test_framework.log`とmonacoindの `debug.log`がすべてトラブルシューティングのためにコンソールにダンプされます。

コンソールに出力されるログのレベルを変更するには、コマンドライン引数 `-l`を使用します。

`combine_logs.py`スクリプトを実行することにより、` test_framework.log`とmonacoind `debug.log`sを1つの集約ログに結合できます。
出力は、プレーンテキスト、色付きテキスト、またはhtmlです。 For 例：

```
combine_logs.py -c <test data directory> | less -r
```

色付きのログをテストからlessにパイプします。

コンソールへのすべてのRPC呼び出しと応答を追跡するには、 `--tracerpc`を使用します。 一部のテスト（たとえば、`submitblock`を使用してRPC経由で完全なブロックを送信するテスト）では、多くの画面出力が発生する可能性があります。

デフォルトでは、テストデータディレクトリは、実行が成功すると削除されます。
テストデータディレクトリをそのまま残すには、 `--nocleanup`を使用します。 テストに失敗すると、テストデータディレクトリは削除されません。

##### デバッガーの接続

Pythonデバッガーは、いつでもテストに参加できます。
次の行を追加するだけです：

```py
import pdb; pdb.set_trace()
```

テストのどこでも。その後、変数を検査したり、テスト対象のモナコノードと相互作用するメソッドを呼び出したりすることができます。

monacoindインスタンス自体のさらなるイントロスペクションが必要になった場合、まず適切な場所にpdbブレークポイントを設定し、そのポイントまでテストを実行し、次に `gdb`を使用してプロセスにアタッチしてデバッグすることでこれを実現できます。

たとえば、実行中に `self.node[1]`にアタッチするには：

```bash
2017-06-27 14:13:56.686000 TestFramework (INFO): Initializing test directory /tmp/user/1000/testo9vsdjo3
```

ディレクトリパスを使用して、pidファイルからpidを取得します。

```bash
cat /tmp/user/1000/testo9vsdjo3/node1/regtest/monacoind.pid
gdb /home/example/monacoind <pid>
```

注：gdb接続ステップには`sudo`が必要な場合があります

### Util tests

utilテストは、 `test/util/bitcoin-util-test.py`を実行することによりローカルで実行できます。
詳細出力には、 `-v`オプションを使用します。

# 機能テストを書く

新規または既存の機能の機能テストを作成することをお勧めします。
機能テストフレームワークと個々のテストの詳細については、 [test/functional](/test/functional)をご覧ください。